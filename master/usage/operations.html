

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DataFlows - shouldi &mdash; DFFML 0.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plugins" href="../plugins/index.html" />
    <link rel="prev" title="Integrating Machine Learning" href="integration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DFFML
          

          
          </a>

          
            
            
              <div class="version">
                0.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Usage Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="integration.html">Integrating Machine Learning</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">DataFlows - shouldi</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tools">Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plan">Plan</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-our-package">Creating our Package</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-static-analysis-tools">Installing Static Analysis Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#safety-operation">Safety Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bandit-operation">Bandit Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-s-the-data-flow">What’s the Data Flow?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pypi-operations">PyPi Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cli">CLI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DFFML</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Usage Examples</a> &raquo;</li>
        
      <li>DataFlows - shouldi</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usage/operations.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dataflows-shouldi">
<h1>DataFlows - shouldi<a class="headerlink" href="#dataflows-shouldi" title="Permalink to this headline">¶</a></h1>
<p>This example will show you how to generate a dataset using operations. In the
process we’ll create a meta static analysis tool, <code class="docutils literal notranslate"><span class="pre">shouldi</span></code>.</p>
<p>Operations are the core of DFFML, they have inputs and outputs, are configurable
and are run by the Orchestrator in what amounts to a large event loop.
The events in the event loop are pieces of data entering the network. When a
piece of data which matches the data types of one of the operations inputs
enters the network, that operation is then run.</p>
<p>We’re going to write a few operations which will run some Python static analysis
tools. With the goal being to create a command line utility called <code class="docutils literal notranslate"><span class="pre">shouldi</span></code>
which will provide us with the information we need to make the decision, should
I install Python package X? When it’s done it’ll look like this</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> shouldi install dffml bandit
<span class="go">dffml is okay to install</span>
<span class="go">Do not install insecure-package! {&#39;safety_check_number_of_issues&#39;: 1}</span>
</pre></div>
</div>
<div class="section" id="tools">
<h2>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h2>
<p>We’ll write this meta static analysis tool by collecting and interpreting the
output of static analysis tools. The two tools we’ll use are <code class="docutils literal notranslate"><span class="pre">safety</span></code> and
<code class="docutils literal notranslate"><span class="pre">bandit</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">safety</span></code> is a tool that checks for known vulnerabilities in packages published
on PyPi. This is how running safety on the command line works, we supply the
package name and version.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> insecure-package<span class="o">==</span><span class="m">0</span>.1.0 <span class="p">|</span> safety check --stdin
<span class="go">╒══════════════════════════════════════════════════════════════════════════════╕</span>
<span class="go">│                                                                              │</span>
<span class="go">│                               /$$$$$$            /$$                         │</span>
<span class="go">│                              /$$__  $$          | $$                         │</span>
<span class="go">│           /$$$$$$$  /$$$$$$ | $$  \__//$$$$$$  /$$$$$$   /$$   /$$           │</span>
<span class="go">│          /$$_____/ |____  $$| $$$$   /$$__  $$|_  $$_/  | $$  | $$           │</span>
<span class="go">│         |  $$$$$$   /$$$$$$$| $$_/  | $$$$$$$$  | $$    | $$  | $$           │</span>
<span class="go">│          \____  $$ /$$__  $$| $$    | $$_____/  | $$ /$$| $$  | $$           │</span>
<span class="go">│          /$$$$$$$/|  $$$$$$$| $$    |  $$$$$$$  |  $$$$/|  $$$$$$$           │</span>
<span class="go">│         |_______/  \_______/|__/     \_______/   \___/   \____  $$           │</span>
<span class="go">│                                                          /$$  | $$           │</span>
<span class="go">│                                                         |  $$$$$$/           │</span>
<span class="go">│  by pyup.io                                              \______/            │</span>
<span class="go">│                                                                              │</span>
<span class="go">╞══════════════════════════════════════════════════════════════════════════════╡</span>
<span class="go">│ REPORT                                                                       │</span>
<span class="go">│ checked 1 packages, using default DB                                         │</span>
<span class="go">╞════════════════════════════╤═══════════╤══════════════════════════╤══════════╡</span>
<span class="go">│ package                    │ installed │ affected                 │ ID       │</span>
<span class="go">╞════════════════════════════╧═══════════╧══════════════════════════╧══════════╡</span>
<span class="go">│ insecure-package           │ 0.1.0     │ &lt;0.2.0                   │ 25853    │</span>
<span class="go">╘══════════════════════════════════════════════════════════════════════════════╛</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bandit</span></code> is a tool that does static analysis on the source code of Python
projects to check for things like SQL injections. This is how running <code class="docutils literal notranslate"><span class="pre">bandit</span></code>
on the command line works, we supply the path to the source directory to scan.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> bandit -r distributed-android-testing/
<span class="go">[main]  INFO    profile include tests: None</span>
<span class="go">[main]  INFO    profile exclude tests: None</span>
<span class="go">[main]  INFO    cli include tests: None</span>
<span class="go">[main]  INFO    cli exclude tests: None</span>
<span class="go">[main]  INFO    running on Python 3.7.3</span>
<span class="go">67 [0.. 50.. ]</span>
<span class="go">Run started:2019-10-04 19:41:06.701058</span>

<span class="go">Test results:</span>
<span class="gp">&gt;</span>&gt; Issue: <span class="o">[</span>B108:hardcoded_tmp_directory<span class="o">]</span> Probable insecure usage of temp file/directory.
<span class="go">   Severity: Medium   Confidence: Medium</span>
<span class="go">   Location: distributed-android-testing/docker/docker.py:20</span>
<span class="go">   More Info: https://bandit.readthedocs.io/en/latest/plugins/b108_hardcoded_tmp_directory.html</span>
<span class="go">19              &quot;chmod 700 /tmp/docker_install.sh&quot;,</span>
<span class="go">20              &quot;/tmp/docker_install.sh&quot;,</span>
<span class="go">21              &quot;usermod -aG docker ${USER}&quot;,</span>
<span class="go">22              &quot;service docker restart&quot;</span>
<span class="go">23          ]</span>
<span class="go">24          kwargs[&quot;sudo&quot;] = True</span>
<span class="go">25          ssh.run_all(command, **kwargs)</span>

<span class="go">--------------------------------------------------</span>
<span class="gp">&gt;</span>&gt; Issue: <span class="o">[</span>B104:hardcoded_bind_all_interfaces<span class="o">]</span> Possible binding to all interfaces.
<span class="go">   Severity: Medium   Confidence: Medium</span>
<span class="go">   Location: distributed-android-testing/docker/gitlab_webhooks/app.py:23</span>
<span class="go">   More Info: https://bandit.readthedocs.io/en/latest/plugins/b104_hardcoded_bind_all_interfaces.html</span>
<span class="go">22      PORT = 9898</span>
<span class="go">23      ADDRESS = &quot;0.0.0.0&quot;</span>
<span class="go">24      STREAM = True</span>
</pre></div>
</div>
</div>
<div class="section" id="plan">
<h2>Plan<a class="headerlink" href="#plan" title="Permalink to this headline">¶</a></h2>
<p>Our plan is to run these tools and make a decision as to if we should install
the package or not based on their reports.</p>
<p>The first step will be to write an <code class="docutils literal notranslate"><span class="pre">Operation</span></code> which wraps each tool.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">Operation</span></code> is similar to a function signature, it consists of a name,
inputs, and outputs. The <code class="docutils literal notranslate"><span class="pre">op</span></code> decorator is a shorthand way of creating an
<code class="docutils literal notranslate"><span class="pre">Operation</span></code> from a function. An <code class="docutils literal notranslate"><span class="pre">Operation</span></code> is analogous to a function
prototype in C.</p>
</div>
<div class="section" id="creating-our-package">
<h2>Creating our Package<a class="headerlink" href="#creating-our-package" title="Permalink to this headline">¶</a></h2>
<p>Create a new package using the create script.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> dffml service dev create operations shouldi
<span class="gp">$</span> <span class="nb">cd</span> shouldi
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the code for this example is located under the
<a class="reference external" href="https://github.com/intel/dffml/blob/master/examples/shouldi/">examples/shouldi</a>
directory of the DFFML source code.</p>
</div>
</div>
<div class="section" id="installing-static-analysis-tools">
<h2>Installing Static Analysis Tools<a class="headerlink" href="#installing-static-analysis-tools" title="Permalink to this headline">¶</a></h2>
<p>The tools we’ll be using are <code class="docutils literal notranslate"><span class="pre">bandit</span></code> and <code class="docutils literal notranslate"><span class="pre">safety</span></code>. We’ll also need to make
http requests so let’s install <code class="docutils literal notranslate"><span class="pre">aiohttp</span></code> too.</p>
<p>Some people are familiar with the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file used to declare
dependences. For packages, we can declare our dependencies right in our
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file.</p>
<p><strong>setup.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SETUP_KWARGS</span><span class="p">[</span><span class="s2">&quot;install_requires&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;aiohttp&gt;=3.5.4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bandit&gt;=1.6.2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;safety&gt;=1.8.5&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These versions will change over time, you should always check PyPi to find
the latest version and use that version.</p>
</div>
<p>Now install the newly created package in development mode.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 -m pip install -e .
</pre></div>
</div>
</div>
<div class="section" id="safety-operation">
<h2>Safety Operation<a class="headerlink" href="#safety-operation" title="Permalink to this headline">¶</a></h2>
<p>To get parsable output, we’ll run <code class="docutils literal notranslate"><span class="pre">safety</span></code> with the <code class="docutils literal notranslate"><span class="pre">--json</span></code> flag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> insecure-package<span class="o">==</span><span class="m">0</span>.1.0 <span class="p">|</span> safety check --stdin --json
<span class="go">[</span>
<span class="go">    [</span>
<span class="go">        &quot;insecure-package&quot;,</span>
<span class="go">        &quot;&lt;0.2.0&quot;,</span>
<span class="go">        &quot;0.1.0&quot;,</span>
<span class="go">        &quot;This is an insecure package with lots of exploitable security vulnerabilities.&quot;,</span>
<span class="go">        &quot;25853&quot;</span>
<span class="go">    ]</span>
<span class="go">]</span>
</pre></div>
</div>
<p>Let’s now write the operation to call <code class="docutils literal notranslate"><span class="pre">safety</span></code> via a subprocess.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">dffml.df.types</span> <span class="k">import</span> <span class="n">Definition</span>
<span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">op</span>

<span class="kn">from</span> <span class="nn">.pypi</span> <span class="k">import</span> <span class="n">package</span><span class="p">,</span> <span class="n">package_version</span>

<span class="n">safety_check_number_of_issues</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;safety_check_number_of_issues&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;int&quot;</span>
<span class="p">)</span>


<span class="nd">@op</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;safety_check&quot;</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="n">package</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">package_version</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">safety_check_number_of_issues</span><span class="p">},</span>
    <span class="n">conditions</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">safety_check</span><span class="p">(</span><span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">pinned</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{package}</span><span class="s2">==</span><span class="si">{version}</span><span class="s2">&quot;</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;safety&quot;</span><span class="p">,</span>
        <span class="s2">&quot;check&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--stdin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--json&quot;</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pinned</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

    <span class="n">issues</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)}</span>
</pre></div>
</div>
<p>Write a test for it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">BaseConfig</span>
<span class="kn">from</span> <span class="nn">dffml.util.asynctestcase</span> <span class="k">import</span> <span class="n">AsyncTestCase</span>

<span class="kn">from</span> <span class="nn">shouldi.safety</span> <span class="k">import</span> <span class="n">safety_check</span>


<span class="k">class</span> <span class="nc">TestSafetyCheck</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">safety_check</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">safety</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">safety</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="s2">&quot;insecure-package&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the tests</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 setup.py <span class="nb">test</span> -s tests.test_safety
</pre></div>
</div>
</div>
<div class="section" id="bandit-operation">
<h2>Bandit Operation<a class="headerlink" href="#bandit-operation" title="Permalink to this headline">¶</a></h2>
<p>To get parsable output, we’ll run with the <code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">json</span></code> flag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> bandit -r -f json distributed-android-testing/
<span class="go">{</span>
<span class="go">  &quot;metrics&quot;: {</span>
<span class="go">    &quot;_totals&quot;: {</span>
<span class="go">      &quot;CONFIDENCE.HIGH&quot;: 9.0,</span>
<span class="go">      &quot;CONFIDENCE.LOW&quot;: 0.0,</span>
<span class="go">      &quot;CONFIDENCE.MEDIUM&quot;: 3.0,</span>
<span class="go">      &quot;CONFIDENCE.UNDEFINED&quot;: 0.0,</span>
<span class="go">      &quot;SEVERITY.HIGH&quot;: 0.0,</span>
<span class="go">      &quot;SEVERITY.LOW&quot;: 10.0,</span>
<span class="go">      &quot;SEVERITY.MEDIUM&quot;: 2.0,</span>
<span class="go">      &quot;SEVERITY.UNDEFINED&quot;: 0.0,</span>
<span class="go">      &quot;loc&quot;: 5658,</span>
<span class="go">      &quot;nosec&quot;: 0</span>
<span class="go">    }</span>
<span class="go">  },</span>
<span class="go">  &quot;results&quot;: [</span>
<span class="go">    {</span>
<span class="go">      &quot;code&quot;: &quot;19         \&quot;chmod 700 /tmp/docker_install.sh\&quot;,\n20         \&quot;/tmp/docker_install.sh\&quot;,\n21         \&quot;usermod -aG docker ${USER}\&quot;,\n22         \&quot;service docker restart\&quot;\n23     ]\n24     kwargs[\&quot;sudo\&quot;] = True\n25     ssh.run_all(command, **kwargs)\n&quot;,</span>
<span class="go">      &quot;filename&quot;: &quot;distributed-android-testing/docker/docker.py&quot;,</span>
<span class="go">      &quot;issue_confidence&quot;: &quot;MEDIUM&quot;,</span>
<span class="go">      &quot;issue_severity&quot;: &quot;MEDIUM&quot;,</span>
<span class="go">      &quot;issue_text&quot;: &quot;Probable insecure usage of temp file/directory.&quot;,</span>
<span class="go">      &quot;line_number&quot;: 20,</span>
<span class="go">      &quot;line_range&quot;: [</span>
<span class="go">        18,</span>
<span class="go">        19,</span>
<span class="go">        20,</span>
<span class="go">        21,</span>
<span class="go">        22</span>
<span class="go">      ],</span>
<span class="go">      &quot;more_info&quot;: &quot;https://bandit.readthedocs.io/en/latest/plugins/b108_hardcoded_tmp_directory.html&quot;,</span>
<span class="go">      &quot;test_id&quot;: &quot;B108&quot;,</span>
<span class="go">      &quot;test_name&quot;: &quot;hardcoded_tmp_directory&quot;</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">      &quot;code&quot;: &quot;22 PORT = 9898\n23 ADDRESS = \&quot;0.0.0.0\&quot;\n24 STREAM = True\n&quot;,</span>
<span class="go">      &quot;filename&quot;: &quot;distributed-android-testing/docker/gitlab_webhooks/app.py&quot;,</span>
<span class="go">      &quot;issue_confidence&quot;: &quot;MEDIUM&quot;,</span>
<span class="go">      &quot;issue_severity&quot;: &quot;MEDIUM&quot;,</span>
<span class="go">      &quot;issue_text&quot;: &quot;Possible binding to all interfaces.&quot;,</span>
<span class="go">      &quot;line_number&quot;: 23,</span>
<span class="go">      &quot;line_range&quot;: [</span>
<span class="go">        23</span>
<span class="go">      ],</span>
<span class="go">      &quot;more_info&quot;: &quot;https://bandit.readthedocs.io/en/latest/plugins/b104_hardcoded_bind_all_interfaces.html&quot;,</span>
<span class="go">      &quot;test_id&quot;: &quot;B104&quot;,</span>
<span class="go">      &quot;test_name&quot;: &quot;hardcoded_bind_all_interfaces&quot;</span>
<span class="go">    }</span>
<span class="go">  ]</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Let’s now write the operation to call <code class="docutils literal notranslate"><span class="pre">safety</span></code> via a subprocess.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>


<span class="kn">from</span> <span class="nn">dffml.df.types</span> <span class="k">import</span> <span class="n">Definition</span>
<span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">op</span>
<span class="kn">from</span> <span class="nn">.pypi</span> <span class="k">import</span> <span class="n">package_src_dir</span>

<span class="n">bandit_output</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;bandit_output&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">)</span>


<span class="nd">@op</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pkg&quot;</span><span class="p">:</span> <span class="n">package_src_dir</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">bandit_output</span><span class="p">})</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_bandit</span><span class="p">(</span><span class="n">pkg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CLI usage: dffml service dev run -log debug shouldi.bandit:run_bandit -pkg .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bandit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="n">pkg</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">stdout</span><span class="p">,</span> <span class="n">_stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span>
    <span class="n">bandit_op</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">bandit_op</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">bandit_op</span><span class="p">)</span>
    <span class="n">t_results</span> <span class="o">=</span> <span class="n">bandit_op</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
    <span class="n">high_sev_high_conf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">t_results</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;issue_confidence&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HIGH&quot;</span>
            <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;issue_severity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HIGH&quot;</span>
        <span class="p">):</span>
            <span class="n">high_sev_high_conf</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">final_result</span> <span class="o">=</span> <span class="n">bandit_op</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;_totals&quot;</span><span class="p">]</span>
    <span class="n">final_result</span><span class="p">[</span><span class="s2">&quot;CONFIDENCE.HIGH_AND_SEVERITY.HIGH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_sev_high_conf</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">final_result</span><span class="p">}</span>
</pre></div>
</div>
<p>Write a test for it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">BaseConfig</span>
<span class="kn">from</span> <span class="nn">dffml.util.asynctestcase</span> <span class="k">import</span> <span class="n">AsyncTestCase</span>

<span class="kn">from</span> <span class="nn">shouldi.bandit</span> <span class="k">import</span> <span class="n">run_bandit</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">TestRunBanditOp</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">run_bandit</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">bandit_latest</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">bandit_latest</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s2">&quot;pkg&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">][</span><span class="s2">&quot;CONFIDENCE.HIGH_AND_SEVERITY.HIGH&quot;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="mf">5.0</span><span class="p">,</span>
                <span class="p">)</span>
</pre></div>
</div>
<p>Run the tests</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 setup.py <span class="nb">test</span> -s tests.test_bandit
</pre></div>
</div>
</div>
<div class="section" id="what-s-the-data-flow">
<h2>What’s the Data Flow?<a class="headerlink" href="#what-s-the-data-flow" title="Permalink to this headline">¶</a></h2>
<p>So far <code class="docutils literal notranslate"><span class="pre">shouldi</span></code> uses two tools.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bandit</span></code></p>
<ul>
<li><p>Which runs checks on the source code of a package to look for things like
SQL injections</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">safety</span></code></p>
<ul>
<li><p>Which checks if there are any open CVEs in a package</p></li>
</ul>
</li>
</ul>
<p>We’re only planning on providing our tool with the package name though, and
we’ll need the package version to run <code class="docutils literal notranslate"><span class="pre">safety</span></code> and the source code of the
package to run <code class="docutils literal notranslate"><span class="pre">bandit</span></code>.</p>
<p>Let’s outline what else needs to happen to get the package version and source
code of the package to those operations.</p>
<ul class="simple">
<li><p>In the processing stage we run all our data collection operations</p>
<ul>
<li><p>Our input is the <code class="docutils literal notranslate"><span class="pre">package</span></code> name</p>
<ul>
<li><p>This will be given to us on the command line</p></li>
</ul>
</li>
<li><p>Access the PyPi API and get the JSON describing the package information</p></li>
<li><p>Concurrently</p>
<ul>
<li><p>Extract the version from the package information</p>
<ul>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">safety</span></code> using the version and the package name</p></li>
</ul>
</li>
<li><p>Extract the URL of the latest release from the package information</p>
<ul>
<li><p>Use the URL to download and extract the package source to a directory</p>
<ul>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">bandit</span></code> using the package source directory</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>In the cleanup stage we release resources created in the processing stage</p>
<ul>
<li><p>Remove the package source directory</p></li>
</ul>
</li>
<li><p>In the output stage we run operations which select data generated in the
processing stage and use that selected data as the output of the dataflow.</p>
<ul>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">get_single</span></code> operation which selects data matching the definitions
we care about.</p></li>
</ul>
</li>
</ul>
<p>This is the directed graph that defines the dataflow of operations that make
up <code class="docutils literal notranslate"><span class="pre">shouldi</span></code> it shows us how all the operation we talked about above are
connected.</p>
<img alt="Diagram showing Dataflow" src="../_images/shouldi-dataflow.png" />
</div>
<div class="section" id="pypi-operations">
<h2>PyPi Operations<a class="headerlink" href="#pypi-operations" title="Permalink to this headline">¶</a></h2>
<p>Let’s write an operation to grab the version of a package.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">dffml.df.types</span> <span class="k">import</span> <span class="n">Definition</span><span class="p">,</span> <span class="n">Stage</span>
<span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">op</span>

<span class="n">package</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
<span class="n">package_json</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;package_json&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">)</span>
<span class="n">package_version</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;package_version&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
<span class="n">package_url</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;package_url&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
<span class="n">package_src_dir</span> <span class="o">=</span> <span class="n">Definition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;package_src_dir&quot;</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>


<span class="nd">@op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="n">package</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="n">package_json</span><span class="p">},</span>
    <span class="n">imp_enter</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">trust_env</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pypi_package_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;https://pypi.org/pypi/</span><span class="si">{package}</span><span class="s2">/json&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="n">package_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="n">package_json</span><span class="p">}</span>


<span class="nd">@op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="n">package_json</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">package_version</span><span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pypi_latest_package_version</span><span class="p">(</span><span class="n">response_json</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]}</span>


<span class="nd">@op</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="n">package_json</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">package_url</span><span class="p">})</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pypi_package_url</span><span class="p">(</span><span class="n">response_json</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">url_dicts</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;urls&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">url_dict</span> <span class="ow">in</span> <span class="n">url_dicts</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">url_dict</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;source&quot;</span>
            <span class="ow">and</span> <span class="n">url_dict</span><span class="p">[</span><span class="s2">&quot;packagetype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sdist&quot;</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url_dict</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]}</span>


<span class="nd">@op</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">package_url</span><span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">package_src_dir</span><span class="p">},</span>
    <span class="n">imp_enter</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">trust_env</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pypi_package_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">package_src_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;pypi-&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">package_src_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;pypi-&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.tar.gz&quot;</span>
            <span class="p">)</span>
            <span class="n">package_src_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">unpack_archive</span><span class="p">(</span><span class="n">package_src_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package_src_dir</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">package_src_dir</span><span class="p">}</span>


<span class="nd">@op</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">package_src_dir</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{},</span> <span class="n">stage</span><span class="o">=</span><span class="n">Stage</span><span class="o">.</span><span class="n">CLEANUP</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">cleanup_pypi_package</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Write a test for it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">BaseConfig</span>
<span class="kn">from</span> <span class="nn">dffml.util.asynctestcase</span> <span class="k">import</span> <span class="n">AsyncTestCase</span>

<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_json</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_latest_package_version</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_url</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_contents</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">cleanup_pypi_package</span>


<span class="k">class</span> <span class="nc">TestPyPiOperations</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>
    <span class="n">PACKAGE</span> <span class="o">=</span> <span class="s2">&quot;insecure-package&quot;</span>
    <span class="n">INT_RESULT_JSON</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">PACKAGE_URL</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_000_package_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_package_json</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">pypi_package</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_package</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PACKAGE</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;response_json&quot;</span><span class="p">]),</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INT_RESULT_JSON</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;response_json&quot;</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_001_package_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_latest_package_version</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span>
            <span class="n">BaseConfig</span><span class="p">()</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pypi_latest</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_latest</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">INT_RESULT_JSON</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_002_package_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_package_url</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">pypi_url</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_url</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;response_json&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">INT_RESULT_JSON</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;insecure-package-0.1.0.tar.gz&quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">PACKAGE_URL</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_003_package_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PACKAGE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://files.pythonhosted.org/packages/dd/b7/b7318693b356d0e0ba566fb22b72a349a10337880c254e5e7e9f24f4f9b3/insecure-package-0.1.0.tar.gz&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_package_contents</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">pypi_cont</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">pypi_cont</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">PACKAGE_URL</span><span class="p">})</span>
                <span class="n">no_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_files</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_004_cleanup_package</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;temp-&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">cleanup_pypi_package</span><span class="o">.</span><span class="n">imp</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">())</span> <span class="k">as</span> <span class="n">cleanup_cont</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">cleanup_cont</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">({</span><span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="p">{})</span>
</pre></div>
</div>
<p>Run the tests</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 setup.py <span class="nb">test</span> -s tests.test_pypi
</pre></div>
</div>
</div>
<div class="section" id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h2>
<p>Writing the CLI is as simple as importing our operations and having the memory
orchestrator run them. DFFML also provides a quick and dirty CLI abstraction
based on <a class="reference external" href="https://docs.python.org/3/library/argparse.html#module-argparse" title="(in Python v3.8)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">argparse</span></code></a> which will speed things up.</p>
<p><strong>shouldi/cli.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">dffml.df.types</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">dffml.df.base</span> <span class="k">import</span> <span class="n">operation_in</span><span class="p">,</span> <span class="n">opimp_in</span><span class="p">,</span> <span class="n">Operation</span>
<span class="kn">from</span> <span class="nn">dffml.df.memory</span> <span class="k">import</span> <span class="n">MemoryOrchestrator</span>
<span class="kn">from</span> <span class="nn">dffml.operation.output</span> <span class="k">import</span> <span class="n">GetSingle</span>
<span class="kn">from</span> <span class="nn">dffml.util.cli.cmd</span> <span class="k">import</span> <span class="n">CMD</span>
<span class="kn">from</span> <span class="nn">dffml.util.cli.arg</span> <span class="k">import</span> <span class="n">Arg</span>

<span class="kn">from</span> <span class="nn">shouldi.bandit</span> <span class="k">import</span> <span class="n">run_bandit</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_latest_package_version</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_json</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_url</span>
<span class="kn">from</span> <span class="nn">shouldi.pypi</span> <span class="k">import</span> <span class="n">pypi_package_contents</span>
<span class="kn">from</span> <span class="nn">shouldi.safety</span> <span class="k">import</span> <span class="n">safety_check</span>

<span class="c1"># sys.modules[__name__] is a list of everything we&#39;ve imported in this file.</span>
<span class="c1"># opimp_in returns a subset of that list, any OperationImplementations</span>
<span class="n">OPIMPS</span> <span class="o">=</span> <span class="n">opimp_in</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Install</span><span class="p">(</span><span class="n">CMD</span><span class="p">):</span>

    <span class="n">arg_packages</span> <span class="o">=</span> <span class="n">Arg</span><span class="p">(</span>
        <span class="s2">&quot;packages&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Package to check if we should install&quot;</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create an Orchestrator which will manage the running of our operations</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">MemoryOrchestrator</span><span class="o">.</span><span class="n">basic_config</span><span class="p">(</span><span class="o">*</span><span class="n">OPIMPS</span><span class="p">)</span> <span class="k">as</span> <span class="n">orchestrator</span><span class="p">:</span>
            <span class="c1"># Create a orchestrator context, everything in DFFML follows this</span>
            <span class="c1"># one-two context entry pattern</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">orchestrator</span><span class="p">()</span> <span class="k">as</span> <span class="n">octx</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">package_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="p">:</span>
                    <span class="c1"># For each package add a new input set to the network of</span>
                    <span class="c1"># inputs (ictx). Operations run under a context, the context</span>
                    <span class="c1"># here is the package_name to evaluate (the first argument).</span>
                    <span class="c1"># The next arguments are all the inputs we&#39;re seeding the</span>
                    <span class="c1"># network with for that context. We give the package name</span>
                    <span class="c1"># because pypi_latest_package_version needs it to find the</span>
                    <span class="c1"># version, which safety will then use. We also give an input</span>
                    <span class="c1"># to the output operation GetSingle, which takes a list of</span>
                    <span class="c1"># data type definitions we want to select as our results.</span>
                    <span class="k">await</span> <span class="n">octx</span><span class="o">.</span><span class="n">ictx</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span>
                        <span class="n">package_name</span><span class="p">,</span>
                        <span class="n">Input</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">package_name</span><span class="p">,</span>
                            <span class="n">definition</span><span class="o">=</span><span class="n">pypi_package_json</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">],</span>
                        <span class="p">),</span>
                        <span class="n">Input</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">safety_check</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">run_bandit</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="n">definition</span><span class="o">=</span><span class="n">GetSingle</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">],</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># Run all the operations, Each iteration of this loop happens</span>
                <span class="c1"># when all inputs are exhausted for a context, the output</span>
                <span class="c1"># operations are then run and their results are yielded</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">octx</span><span class="o">.</span><span class="n">run_operations</span><span class="p">():</span>
                    <span class="c1"># The context for this data flow was the package name</span>
                    <span class="n">package_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">handle</span><span class="p">())</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
                    <span class="c1"># Get the results of the GetSingle output operation</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">GetSingle</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="c1"># Check if any of the values of the operations evaluate to</span>
                    <span class="c1"># true, so if the number of issues found by safety is</span>
                    <span class="c1"># non-zero then this will be true</span>
                    <span class="n">any_issues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">any_issues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="ow">or</span> <span class="n">any_issues</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;CONFIDENCE.HIGH_AND_SEVERITY.HIGH&quot;</span><span class="p">]</span>
                        <span class="o">&gt;</span> <span class="mi">5</span>
                    <span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Do not install </span><span class="si">{package_name}</span><span class="s2">! </span><span class="si">{results!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{package_name}</span><span class="s2"> is okay to install&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShouldI</span><span class="p">(</span><span class="n">CMD</span><span class="p">):</span>

    <span class="n">install</span> <span class="o">=</span> <span class="n">Install</span>
</pre></div>
</div>
<p>Let’s test out the code in <code class="docutils literal notranslate"><span class="pre">shouldi.cli</span></code> before making it accessible via the
command line.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="k">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">dffml.util.asynctestcase</span> <span class="k">import</span> <span class="n">AsyncTestCase</span>

<span class="kn">from</span> <span class="nn">shouldi.cli</span> <span class="k">import</span> <span class="n">ShouldI</span>


<span class="k">class</span> <span class="nc">TestCLI</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;sys.stdout&quot;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ShouldI</span><span class="o">.</span><span class="n">install</span><span class="o">.</span><span class="n">cli</span><span class="p">(</span><span class="s2">&quot;insecure-package&quot;</span><span class="p">,</span> <span class="s2">&quot;shouldi&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;shouldi is okay to install&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;Do not install insecure-package!&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the all the tests this time</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 setup.py <span class="nb">test</span>
</pre></div>
</div>
<p>If you have coverage installed (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">coverage</span></code>) you can also check the
code coverage.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 -m coverage run setup.py <span class="nb">test</span>
<span class="go">running test</span>
<span class="go">running egg_info</span>
<span class="go">writing shouldi.egg-info/PKG-INFO</span>
<span class="go">writing dependency_links to shouldi.egg-info/dependency_links.txt</span>
<span class="go">writing entry points to shouldi.egg-info/entry_points.txt</span>
<span class="go">writing requirements to shouldi.egg-info/requires.txt</span>
<span class="go">writing top-level names to shouldi.egg-info/top_level.txt</span>
<span class="go">reading manifest file &#39;shouldi.egg-info/SOURCES.txt&#39;</span>
<span class="go">reading manifest template &#39;MANIFEST.in&#39;</span>
<span class="go">writing manifest file &#39;shouldi.egg-info/SOURCES.txt&#39;</span>
<span class="go">running build_ext</span>
<span class="go">test_run (tests.test_safety.TestSafetyCheck) ... ok</span>
<span class="go">test_install (tests.test_cli.TestCLI) ... ok</span>
<span class="go">test_run (tests.test_pypi.TestPyPiLatestPackageVersion) ... ok</span>

<span class="go">----------------------------------------------------------------------</span>
<span class="go">Ran 3 tests in 1.282s</span>

<span class="go">OK</span>
<span class="gp">$</span> python3.7 -m coverage report -m
<span class="go">Name                     Stmts   Miss Branch BrPart  Cover   Missing</span>
<span class="go">--------------------------------------------------------------------</span>
<span class="go">shouldi/__init__.py          0      0      0      0   100%</span>
<span class="go">shouldi/cli.py              27      0      6      0   100%</span>
<span class="go">shouldi/definitions.py       5      0      2      0   100%</span>
<span class="go">shouldi/pypi.py             12      0      2      0   100%</span>
<span class="go">shouldi/safety.py           18      0      0      0   100%</span>
<span class="go">shouldi/version.py           1      0      0      0   100%</span>
<span class="go">tests/__init__.py            0      0      0      0   100%</span>
<span class="go">tests/test_cli.py           11      0      0      0   100%</span>
<span class="go">tests/test_pypi.py           9      0      0      0   100%</span>
<span class="go">tests/test_safety.py         9      0      0      0   100%</span>
<span class="go">--------------------------------------------------------------------</span>
<span class="go">TOTAL                       92      0     10      0   100%</span>
</pre></div>
</div>
<p>We want this to be usable as a command line utility, Python’s
<code class="xref py py-mod docutils literal notranslate"><span class="pre">setuptools</span></code> allows us to define console <code class="docutils literal notranslate"><span class="pre">entry_points</span></code>. All we have
to do is tell <code class="xref py py-mod docutils literal notranslate"><span class="pre">setuptools</span></code> what Python function we want it to call when
a user runs a given command line application. The name of our CLI is <code class="docutils literal notranslate"><span class="pre">shouldi</span></code>
and the function we want to run is <code class="docutils literal notranslate"><span class="pre">main</span></code> in the <code class="docutils literal notranslate"><span class="pre">ShouldI</span></code> class which is in
the <code class="docutils literal notranslate"><span class="pre">shouldi.cli</span></code> module.</p>
<p><strong>setup.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;console_scripts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;shouldi = shouldi.cli:ShouldI.main&quot;</span><span class="p">]},</span>
</pre></div>
</div>
<p>Re-install the package via pip</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 -m pip install -e .
</pre></div>
</div>
<p>Now we should be able to run our new tool via the CLI! (Provided your <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>
is set up correctly.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> shouldi install insecure-package bandit
<span class="go">bandit is okay to install</span>
<span class="go">Do not install insecure-package! {&#39;safety_check_number_of_issues&#39;: 1}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../plugins/index.html" class="btn btn-neutral float-right" title="Plugins" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="integration.html" class="btn btn-neutral float-left" title="Integrating Machine Learning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Intel

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>