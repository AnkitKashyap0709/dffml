
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Example Integration &#8212; DFFML 0.1.2 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example Data Flow Usage" href="operations.html" />
    <link rel="prev" title="Installation" href="installation.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="example-integration">
<h1>Example Integration<a class="headerlink" href="#example-integration" title="Permalink to this headline">¶</a></h1>
<p>This example will show you how to automate a manual classification process,
determining if a Git repo is maintained or abandoned.</p>
<p>For this example assume you are a very curious open source software people (if
you’re here you already are). Since you love looking at GitHub repos in your
free time, you long ago built a Python 2 based CGI web application where, every
time we came across a Git repo, you dug around, looked at the number of
committer, number of commits, etc. To come up with maintenance status. That
status being maintained, or unmaintained.</p>
<img alt="../_images/website-before.png" src="../_images/website-before.png" />
<p>Instead of manually classifying each repo, we’re going to put some machine
learning behind this little web app. The steps we’re going to follow here are
generic, they do not apply specifically to this Python 2 CGI setup, this is just
an example that was chosen because hopefully it’ll be an easy setup.</p>
<div class="section" id="demo-app-setup">
<h2>Demo App Setup<a class="headerlink" href="#demo-app-setup" title="Permalink to this headline">¶</a></h2>
<p>We’ll be using Python 2, 3.7, jq, and docker. So make sure you have all of those
installed. Python 2 is usually installed by default on most systems, your
package manager should have it if not.</p>
<p>Navigate to the <code class="docutils literal notranslate"><span class="pre">maintained</span></code> example, starting at the top directory of the
<code class="docutils literal notranslate"><span class="pre">dffml</span></code> source.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> examples/maintained/
</pre></div>
</div>
<p>Create a virtual environment for Python 3.7.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ virtualenv -p python3.7 .venv
$ . .venv/bin/activate
</pre></div>
</div>
<p>Install DFFML.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install -U dffml
</pre></div>
</div>
<p>Download the Python 2 client libraries for MariaDB (same as MySQL).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python2 -m pip install -U --user <span class="se">\</span>
    https://dev.mysql.com/get/Downloads/Connector-Python/mysql-connector-python-8.0.16.tar.gz
</pre></div>
</div>
<p>Start MariaDB</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker run --rm -d --name maintained_db <span class="se">\</span>
    -e <span class="nv">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="o">=</span>yes <span class="se">\</span>
    -e <span class="nv">MYSQL_USER</span><span class="o">=</span>user <span class="se">\</span>
    -e <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>pass <span class="se">\</span>
    -e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>db <span class="se">\</span>
    -p <span class="m">3306</span>:3306 <span class="se">\</span>
    mariadb
</pre></div>
</div>
<p>Import the data. The data was pulled from a couple pages of GitHub search
results and randomly assigned a maintenance status. It is completely
meaningless.</p>
<p>You could discard all of this data and use the web app to create a meaningful
dataset by manually going through and setting the status of repos.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker run -i --rm --net<span class="o">=</span>host mariadb mysql <span class="se">\</span>
    -h127.0.0.1 <span class="se">\</span>
    -uuser <span class="se">\</span>
    -ppass <span class="se">\</span>
    --database db &lt; db.sql
</pre></div>
</div>
<p>Fire up the CGI server. Yes, this is Python 3 now, but we’re assuming there
was a legacy setup in place, the CGI server could just as well have been running
PHP. In fact a php app that does the same thing would follow these same
integration steps.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python -m http.server --cgi <span class="m">8000</span>
</pre></div>
</div>
</div>
<div class="section" id="gathering-data">
<h2>Gathering Data<a class="headerlink" href="#gathering-data" title="Permalink to this headline">¶</a></h2>
<p>We now have our dataset of git repos and their maintenance statuses in our web
app. If you go to <a class="reference external" href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> you should see it.</p>
<p>Before we can train a model on this dataset, we need to transform it into
something that could be feed to a model. Right now all we have is URLs to git
repos.</p>
<p>Lets pull down that list of repos.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl <span class="s1">&#39;http://127.0.0.1:8000/cgi-bin/api.py?action=dump&#39;</span> <span class="se">\</span>
    <span class="p">|</span> jq -r <span class="s1">&#39;keys[]&#39;</span> <span class="p">|</span> tee /tmp/urls
https://github.com/2bt/vmTetris.git
https://github.com/AntoineMaillard06/Tetris.git
https://github.com/Apolotary/My-tetris-on-python.git
https://github.com/ArthanJans/TetrisPi.git
https://github.com/CRAFT-THU/tetris.git
</pre></div>
</div>
<p>We’re going to run these repos through DFFML’s data flow orchestrator. We’ll
tell the orchestrator to run certain <code class="docutils literal notranslate"><span class="pre">Operations</span></code> on each one of the URLs.
Those <code class="docutils literal notranslate"><span class="pre">Operations</span></code> will scrape data that is representative of the repo’s
maintenance, we can then feed that data into a machine learning model.</p>
<p>The operations we’re going to use are a part of <code class="docutils literal notranslate"><span class="pre">dffml-feature-git</span></code>, which is
a separate Python package from DFFML (although maintained within the same repo)
which we can install via <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install -U dffml-feature-git
</pre></div>
</div>
<p>Operations are just Python functions, or classes. They define a routine which
will be run concurrently with other operations. Here’s an example of the
<code class="docutils literal notranslate"><span class="pre">git_commits</span></code> operation, which will find the number of commits within a date
range.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@op</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="n">git_repository</span><span class="p">,</span>
        <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
        <span class="s1">&#39;start_end&#39;</span><span class="p">:</span> <span class="n">date_pair</span>
        <span class="p">},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;commits&#39;</span><span class="p">:</span> <span class="n">commit_count</span>
        <span class="p">})</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">git_commits</span><span class="p">(</span><span class="n">repo</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_end</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start_end</span>
    <span class="n">commit_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">await</span> <span class="n">create</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--oneline&#39;</span><span class="p">,</span> <span class="s1">&#39;--before&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span>
            <span class="s1">&#39;--after&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">repo</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">])</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">at_eof</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">commit_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">await</span> <span class="n">stop</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;commits&#39;</span><span class="p">:</span> <span class="n">commit_count</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>Since operations are run concurrently with each other, DFFML manages locking of
input data, such as git repositories. This is done via <code class="docutils literal notranslate"><span class="pre">Definitions</span></code> which are
the variables used as values in the <code class="docutils literal notranslate"><span class="pre">input</span></code> and <code class="docutils literal notranslate"><span class="pre">output</span></code> dictionaries.</p>
<p>We’re going to use the operations provided in <code class="docutils literal notranslate"><span class="pre">dffml-feature-git</span></code> to gather
our dataset. First we’ll define which operations we are going to use.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat &gt; /tmp/operations <span class="s">&lt;&lt;EOF</span>
<span class="s">group_by</span>
<span class="s">quarters_back_to_date</span>
<span class="s">check_if_valid_git_repository_URL</span>
<span class="s">clone_git_repo</span>
<span class="s">git_repo_default_branch</span>
<span class="s">git_repo_checkout</span>
<span class="s">git_repo_commit_from_date</span>
<span class="s">git_repo_author_lines_for_dates</span>
<span class="s">work</span>
<span class="s">git_repo_release</span>
<span class="s">git_commits</span>
<span class="s">count_authors</span>
<span class="s">cleanup_git_repo</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>We then run the defined operations through the orchestrator. <code class="docutils literal notranslate"><span class="pre">remap</span></code> and
<code class="docutils literal notranslate"><span class="pre">group_by_spec</span></code> are re-labeling the output’s to the feature data names we
want.</p>
<p>The speed of the following command depends on your internet connection, it may
take 2 minutes, it may take more. All the git repos in <code class="docutils literal notranslate"><span class="pre">/tmp/urls</span></code> will be
downloaded, this will also take up space in <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>, they will be cleaned up
automatically.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml operations repo <span class="se">\</span>
    -log debug <span class="se">\</span>
    -sources <span class="nv">primary</span><span class="o">=</span>json <span class="se">\</span>
    -source-filename /tmp/data.json <span class="se">\</span>
    -update <span class="se">\</span>
    -keys <span class="k">$(</span>cat /tmp/urls<span class="k">)</span> <span class="se">\</span>
    -repo-def URL <span class="se">\</span>
    -remap <span class="se">\</span>
      group_by.work<span class="o">=</span>work <span class="se">\</span>
      group_by.commits<span class="o">=</span>commits <span class="se">\</span>
      group_by.authors<span class="o">=</span>authors <span class="se">\</span>
    -dff-memory-operation-network-ops <span class="k">$(</span>cat /tmp/operations<span class="k">)</span> <span class="se">\</span>
    -dff-memory-opimp-network-opimps <span class="k">$(</span>cat /tmp/operations<span class="k">)</span> <span class="se">\</span>
    -inputs <span class="se">\</span>
      <span class="o">{</span><span class="m">0</span>,1,2,3,4,5,6,7,8,9<span class="o">}=</span>quarter <span class="se">\</span>
      <span class="s2">&quot;&#39;2019-03-29 13:24&#39;=quarter_start_date&quot;</span> <span class="se">\</span>
      <span class="nv">True</span><span class="o">=</span>no_git_branch_given <span class="se">\</span>
    -output-specs <span class="s1">&#39;{</span>
<span class="s1">        &quot;authors&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;author_count&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        },</span>
<span class="s1">        &quot;work&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;work_spread&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        },</span>
<span class="s1">        &quot;commits&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;commit_count&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        }</span>
<span class="s1">      }=group_by_spec&#39;</span>
</pre></div>
</div>
<p>We saved the gathered data to <code class="docutils literal notranslate"><span class="pre">/tmp/data.json</span></code>.</p>
</div>
<div class="section" id="pulling-from-the-database">
<h2>Pulling from the Database<a class="headerlink" href="#pulling-from-the-database" title="Permalink to this headline">¶</a></h2>
<p>Now that we’ve gathered our data. We want to re-associate it with it’s
classifications. To do this we need to access the database.</p>
<p>By copying the example source implementation
<code class="docutils literal notranslate"><span class="pre">examples/source/custom_source.py</span></code> we can quickly modify it to use the
<code class="docutils literal notranslate"><span class="pre">aiomysql</span></code> connector rather than sqlite.</p>
<p>Let’s now install it so we can use it within the DFFML CLI.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install -e .
</pre></div>
</div>
<p>The source we’ve written uses a new table in the database. Lets create it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>DROP TABLE IF EXISTS `ml_data`;
CREATE TABLE IF NOT EXISTS `ml_data` (
  `src_url` VARCHAR(1000) PRIMARY KEY NOT NULL,
  `json` text
);
</pre></div>
</div>
<p>You can pipe that query in with bash like we did the first time.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker run -i --rm --net<span class="o">=</span>host mariadb mysql <span class="se">\</span>
    -h127.0.0.1 <span class="se">\</span>
    -uuser <span class="se">\</span>
    -ppass <span class="se">\</span>
    --database db &lt; db_ml.sql
</pre></div>
</div>
<p>Now we’ll take the data we stored in the json file and merge it back into the
database.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml merge <span class="nv">db</span><span class="o">=</span>demoapp <span class="nv">gathered</span><span class="o">=</span>json <span class="se">\</span>
    -source-gathered-filename /tmp/data.json -log debug
</pre></div>
</div>
<p>List all the repos in the database to confirm all data and classifications show
up as expected.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml list repos -sources <span class="nv">db</span><span class="o">=</span>demoapp
</pre></div>
</div>
</div>
<div class="section" id="training-our-model">
<h2>Training our Model<a class="headerlink" href="#training-our-model" title="Permalink to this headline">¶</a></h2>
<p>The model we’ll be using is a part of <code class="docutils literal notranslate"><span class="pre">dffml-model-tensorflow</span></code>, which is another
separate Python package from DFFML (although maintained within the same repo)
which we can install via <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install -U dffml-model-tensorflow
</pre></div>
</div>
<p>The model is a generic wrapper around Tensorflow’s DNN estimator. We can use it
to train on our dataset.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml train all <span class="se">\</span>
    -model dnn <span class="se">\</span>
    -model-epochs <span class="m">400</span> <span class="se">\</span>
    -model-steps <span class="m">4000</span> <span class="se">\</span>
    -sources <span class="nv">db</span><span class="o">=</span>demoapp <span class="se">\</span>
    -classifications <span class="m">0</span> <span class="m">1</span> <span class="se">\</span>
    -features <span class="se">\</span>
      def:authors:int:10 <span class="se">\</span>
      def:commits:int:10 <span class="se">\</span>
      def:work:int:10 <span class="se">\</span>
    -log debug <span class="se">\</span>
    -update
</pre></div>
</div>
<p>Now let’s assess the accuracy, remember, this is bogus data so this number is
meaningless unless you threw out the dataset and put in real classifications.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml accuracy <span class="se">\</span>
    -model dnn <span class="se">\</span>
    -sources <span class="nv">db</span><span class="o">=</span>demoapp <span class="se">\</span>
    -classifications <span class="m">0</span> <span class="m">1</span> <span class="se">\</span>
    -features <span class="se">\</span>
      def:authors:int:10 <span class="se">\</span>
      def:commits:int:10 <span class="se">\</span>
      def:work:int:10 <span class="se">\</span>
    -log critical
<span class="m">2019</span>-05-23 <span class="m">10</span>:23:40.056553: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94<span class="o">]</span> CPU Frequency: <span class="m">3491950000</span> Hz
<span class="m">2019</span>-05-23 <span class="m">10</span>:23:40.057065: I tensorflow/compiler/xla/service/service.cc:150<span class="o">]</span> XLA service 0x24fe3c0 executing computations on platform Host. Devices:
<span class="m">2019</span>-05-23 <span class="m">10</span>:23:40.057087: I tensorflow/compiler/xla/service/service.cc:158<span class="o">]</span>   StreamExecutor device <span class="o">(</span><span class="m">0</span><span class="o">)</span>: &lt;undefined&gt;, &lt;undefined&gt;
<span class="m">0</span>.4722222089767456
</pre></div>
</div>
<p>The accuracy is 47.22%.</p>
</div>
<div class="section" id="making-a-prediction">
<h2>Making a Prediction<a class="headerlink" href="#making-a-prediction" title="Permalink to this headline">¶</a></h2>
<p>Run the operations on the new repo (<a class="reference external" href="https://github.com/intel/dffml.git">https://github.com/intel/dffml.git</a>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml operations repo <span class="se">\</span>
    -log debug <span class="se">\</span>
    -sources <span class="nv">db</span><span class="o">=</span>demoapp <span class="se">\</span>
    -update <span class="se">\</span>
    -keys https://github.com/intel/dffml.git <span class="se">\</span>
    -repo-def URL <span class="se">\</span>
    -remap <span class="se">\</span>
      group_by.work<span class="o">=</span>work <span class="se">\</span>
      group_by.commits<span class="o">=</span>commits <span class="se">\</span>
      group_by.authors<span class="o">=</span>authors <span class="se">\</span>
    -dff-memory-operation-network-ops <span class="k">$(</span>cat /tmp/operations<span class="k">)</span> <span class="se">\</span>
    -dff-memory-opimp-network-opimps <span class="k">$(</span>cat /tmp/operations<span class="k">)</span> <span class="se">\</span>
    -inputs <span class="se">\</span>
      <span class="o">{</span><span class="m">0</span>,1,2,3,4,5,6,7,8,9<span class="o">}=</span>quarter <span class="se">\</span>
      <span class="s2">&quot;&#39;2019-03-29 13:24&#39;=quarter_start_date&quot;</span> <span class="se">\</span>
      <span class="nv">True</span><span class="o">=</span>no_git_branch_given <span class="se">\</span>
    -output-specs <span class="s1">&#39;{</span>
<span class="s1">        &quot;authors&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;author_count&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        },</span>
<span class="s1">        &quot;work&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;work_spread&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        },</span>
<span class="s1">        &quot;commits&quot;: {</span>
<span class="s1">          &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">          &quot;by&quot;: &quot;commit_count&quot;,</span>
<span class="s1">          &quot;fill&quot;: 0</span>
<span class="s1">        }</span>
<span class="s1">      }=group_by_spec&#39;</span>
</pre></div>
</div>
<p>Now that we have the data for the new repo, ask the model for a prediction.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dffml predict repo <span class="se">\</span>
    -keys https://github.com/intel/dffml.git <span class="se">\</span>
    -model dnn <span class="se">\</span>
    -sources <span class="nv">db</span><span class="o">=</span>demoapp <span class="se">\</span>
    -classifications <span class="m">0</span> <span class="m">1</span> <span class="se">\</span>
    -features <span class="se">\</span>
      def:authors:int:10 <span class="se">\</span>
      def:commits:int:10 <span class="se">\</span>
      def:work:int:10 <span class="se">\</span>
    -log critical <span class="se">\</span>
    -update
<span class="m">2019</span>-05-23 <span class="m">10</span>:33:03.468591: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94<span class="o">]</span> CPU Frequency: <span class="m">3491950000</span> Hz
<span class="m">2019</span>-05-23 <span class="m">10</span>:33:03.469217: I tensorflow/compiler/xla/service/service.cc:150<span class="o">]</span> XLA service 0x4394920 executing computations on platform Host. Devices:
<span class="m">2019</span>-05-23 <span class="m">10</span>:33:03.469235: I tensorflow/compiler/xla/service/service.cc:158<span class="o">]</span>   StreamExecutor device <span class="o">(</span><span class="m">0</span><span class="o">)</span>: &lt;undefined&gt;, &lt;undefined&gt;
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;classification&quot;</span>: <span class="s2">&quot;&quot;</span>,
        <span class="s2">&quot;extra&quot;</span>: <span class="o">{}</span>,
        <span class="s2">&quot;features&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;authors&quot;</span>: <span class="o">[</span>
                <span class="m">5</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>
            <span class="o">]</span>,
            <span class="s2">&quot;commits&quot;</span>: <span class="o">[</span>
                <span class="m">39</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>
            <span class="o">]</span>,
            <span class="s2">&quot;work&quot;</span>: <span class="o">[</span>
                <span class="m">4</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>,
                <span class="m">0</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&quot;last_updated&quot;</span>: <span class="s2">&quot;2019-05-23T10:33:03Z&quot;</span>,
        <span class="s2">&quot;prediction&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;classification&quot;</span>: <span class="s2">&quot;0&quot;</span>,
            <span class="s2">&quot;confidence&quot;</span>: <span class="m">1</span>.0
        <span class="o">}</span>,
        <span class="s2">&quot;src_url&quot;</span>: <span class="s2">&quot;https://github.com/intel/dffml.git&quot;</span>
    <span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="modifying-the-legacy-app">
<h2>Modifying the Legacy App<a class="headerlink" href="#modifying-the-legacy-app" title="Permalink to this headline">¶</a></h2>
<p>Now let’s add a ‘Predict’ button to the app. The button will trigger the
operations to be run on the new URL, and then the prediction. The demo app will
then take the predicted classification and record that as the classification in
the database.</p>
<p><strong>examples/maintained/index.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Submit or change the maintenance status of a repo.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;URL&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;git://server.git/repo&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">input</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;maintained&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;good&quot;</span><span class="p">&gt;</span>Maintained<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;unmaintained&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dangerous&quot;</span><span class="p">&gt;</span>Unmaintained<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;predict&quot;</span><span class="p">&gt;</span>Predict<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The predict button will trigger an HTTP call to the CGI API. The CGI script will
run the same commands we just ran on the command line, and parse the output,
which is in JSON format, and set the resulting prediction classification in the
database.</p>
<p><strong>examples/maintained/cgi-bin/api.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the imports we&#39;ll be using to the top of api.py</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># ...</span>

<span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">:</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;group_by&#39;</span><span class="p">,</span>
        <span class="s1">&#39;quarters_back_to_date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;check_if_valid_git_repository_URL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clone_git_repo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_repo_default_branch&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_repo_checkout&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_repo_commit_from_date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_repo_author_lines_for_dates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;work&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_repo_release&#39;</span><span class="p">,</span>
        <span class="s1">&#39;git_commits&#39;</span><span class="p">,</span>
        <span class="s1">&#39;count_authors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cleanup_git_repo&#39;</span>
        <span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(([</span>
        <span class="s1">&#39;dffml&#39;</span><span class="p">,</span> <span class="s1">&#39;operations&#39;</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-log&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-sources&#39;</span><span class="p">,</span> <span class="s1">&#39;db=demoapp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-update&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-keys&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">],</span>
        <span class="s1">&#39;-repo-def&#39;</span><span class="p">,</span> <span class="s1">&#39;URL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-remap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;group_by.work=work&#39;</span><span class="p">,</span>
        <span class="s1">&#39;group_by.commits=commits&#39;</span><span class="p">,</span>
        <span class="s1">&#39;group_by.authors=authors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-dff-memory-operation-network-ops&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">operations</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s1">&#39;-dff-memory-opimp-network-opimps&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">operations</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s1">&#39;-inputs&#39;</span><span class="p">]</span> <span class="o">+</span> \
        <span class="p">[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">=quarter&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">=quarter_start_date&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">today</span><span class="p">,),</span>
        <span class="s1">&#39;True=no_git_branch_given&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-output-specs&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;{</span>
<span class="s1">            &quot;authors&quot;: {</span>
<span class="s1">              &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">              &quot;by&quot;: &quot;author_count&quot;,</span>
<span class="s1">              &quot;fill&quot;: 0</span>
<span class="s1">            },</span>
<span class="s1">            &quot;work&quot;: {</span>
<span class="s1">              &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">              &quot;by&quot;: &quot;work_spread&quot;,</span>
<span class="s1">              &quot;fill&quot;: 0</span>
<span class="s1">            },</span>
<span class="s1">            &quot;commits&quot;: {</span>
<span class="s1">              &quot;group&quot;: &quot;quarter&quot;,</span>
<span class="s1">              &quot;by&quot;: &quot;commit_count&quot;,</span>
<span class="s1">              &quot;fill&quot;: 0</span>
<span class="s1">            }</span>
<span class="s1">          }=group_by_spec&#39;&#39;&#39;</span><span class="p">]))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span>
        <span class="s1">&#39;dffml&#39;</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-keys&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">],</span>
        <span class="s1">&#39;-model&#39;</span><span class="p">,</span> <span class="s1">&#39;dnn&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-sources&#39;</span><span class="p">,</span> <span class="s1">&#39;db=demoapp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-classifications&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-features&#39;</span><span class="p">,</span>
        <span class="s1">&#39;def:authors:int:10&#39;</span><span class="p">,</span>
        <span class="s1">&#39;def:commits:int:10&#39;</span><span class="p">,</span>
        <span class="s1">&#39;def:work:int:10&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-log&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-update&#39;</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;REPLACE INTO status (src_url, maintained) VALUES(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s1">&#39;URL&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">][</span><span class="s1">&#39;classification&#39;</span><span class="p">],))</span>
    <span class="n">cnx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Hook up the predict button to call our new API.</p>
<p><strong>examples/maintained/ml.js</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">predict</span><span class="p">(</span><span class="nx">URL</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;cgi-bin/api.py?action=predict&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;maintained=&#39;</span> <span class="o">+</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">maintained</span><span class="p">)</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;URL=&#39;</span> <span class="o">+</span> <span class="nx">URL</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
  <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tableDOM</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">URLDOM</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;URL&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">predictDOM</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">);</span>

  <span class="nx">predictDOM</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">predict</span><span class="p">(</span><span class="nx">URLDOM</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">refreshTable</span><span class="p">(</span><span class="nx">tableDOM</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Finally, import the new script into the main page.</p>
<p><strong>examples/maintained/index.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Git Repo Maintenance Tracker<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;main.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;ml.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;theme.css&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Visit the web app, and input a Git repo to evaluate into the input field. Then
click predict. The demo gif has had all the entries DROPed from the database.
But you can look through the table and you’ll find that a prediction has been
run on the repo. Congratulations! You’ve automated a manual classification
process, and integrated machine learning into a legacy application.</p>
<img alt="../_images/integration_demo.gif" src="../_images/integration_demo.gif" />
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">DFFML</a></h1>



<p class="blurb">The fastest path to machine learning integration</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=intel&repo=dffml&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/intel/dffml">
    <img
        alt="https://secure.travis-ci.org/intel/dffml.svg?branch=master"
        src="https://secure.travis-ci.org/intel/dffml.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/intel/dffml">
    <img
    alt="https://codecov.io/github/intel/dffml/coverage.svg?branch=master"
    src="https://codecov.io/github/intel/dffml/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#demo-app-setup">Demo App Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gathering-data">Gathering Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pulling-from-the-database">Pulling from the Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#training-our-model">Training our Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-a-prediction">Making a Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modifying-the-legacy-app">Modifying the Legacy App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="operations.html">Example Data Flow Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="installation.html" title="previous chapter">Installation</a></li>
      <li>Next: <a href="operations.html" title="next chapter">Example Data Flow Usage</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Intel.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/usage/integration.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>